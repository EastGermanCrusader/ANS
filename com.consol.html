<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Starship COMMS SDR – 0…10 THz</title>
<style>
  :root{--bg:#12151b;--fg:#d7e1ff;--muted:#8b95b7;--line:#273043}
  *{box-sizing:border-box;font-family:monospace,Courier,fixed}
  html,body{height:100%}
  body{margin:0;background:#12151b;color:#d7e1ff;min-height:100vh;display:flex;flex-direction:column;overflow:hidden}

  .wip-banner{position:relative;height:40px;overflow:hidden;background:#000;z-index:100}
  .wip-stripes{position:absolute;inset:0;pointer-events:none;opacity:.8;
    background:repeating-linear-gradient(45deg,#ffd400 0px,#ffd400 10px,#000 10px,#000 20px);
    animation:wipStripes 2s linear infinite}
  @keyframes wipStripes{0%{transform:translateX(0)}100%{transform:translateX(20px)}}
  .wip-banner__text{position:relative;display:flex;align-items:center;justify-content:center;gap:12px;
    height:40px;white-space:nowrap;color:#fff;font-weight:bold;letter-spacing:.1em;text-shadow:1px 1px 2px #000}
  .wip-btn{border:1px solid #333;border-radius:4px;padding:4px 8px;background:#141414;color:#fff;cursor:pointer}

  header{padding:10px 12px;border-bottom:1px solid #273043;display:flex;gap:12px;align-items:center}
  .wrap{flex:1;min-height:0;display:block;padding:12px;overflow:hidden}
  .layout{display:table;width:100%;height:100%}
  .maincol{display:table-cell;width:70%;vertical-align:top;padding-right:12px}
  .sidecol{display:table-cell;width:30%;vertical-align:top;min-width:280px}
  .canvas-container{position:relative;height:100%}
  .spectrum-container{height:30%;margin-bottom:8px}
  .waterfall-container{height:70%}
  canvas{background:#0a0c11;border:1px solid #273043;border-radius:4px;display:block;width:100%;height:100%;image-rendering:pixelated}
  aside.panel{border:1px solid #273043;border-radius:4px;padding:10px;background:#0f1218;height:100%;overflow-y:auto}
  input,select,button{background:#0b0e14;border:1px solid #273043;border-radius:3px;color:#d7e1ff;padding:4px;font-size:12px}
  .row{display:block;margin-bottom:8px}
  .row label{display:inline-block;width:70px;font-size:11px;color:#8b95b7}
  .row input,.row select{width:180px;margin-right:4px}
  .row button{margin-right:4px}
  .small{font-size:11px;color:#8b95b7}
  footer{padding:6px 12px;border-top:1px solid #273043;color:#8b95b7;font-size:11px}
  @media (max-width:800px){.layout{display:block}.maincol,.sidecol{display:block;width:100%;padding:0}.sidecol{margin-top:12px}}
</style>
</head>
<body>
  <div class="wip-banner">
    <div class="wip-stripes"></div>
    <div class="wip-banner__text">
      ⚠️ STARSHIP COMMS SDR PROTOTYP 0-10 THz (GMod) ⚠️
      <button id="audioStart" class="wip-btn">Audio Start</button>
      <button id="audioToggle" class="wip-btn" style="display:none">Audio Pause</button>
    </div>
  </div>

  <header>
    <h1>STARSHIP COMMS SDR</h1>
    <span class="small">Wheel=Zoom • Drag=Pan • Click=Listen • DblClick=Center</span>
  </header>

  <div class="wrap">
    <div class="layout">
      <div class="maincol">
        <div class="canvas-container">
          <div class="spectrum-container"><canvas id="spectrum"></canvas></div>
          <div class="waterfall-container"><canvas id="waterfall"></canvas></div>
        </div>
      </div>

      <div class="sidecol">
        <aside class="panel">
          <div class="row">
            <label>CSV-Plan:</label>
            <input id="csvUrl" placeholder="https://.../export?format=csv">
            <button id="csvLoad">Laden</button>
          </div>

          <div class="row">
            <label>Freq:</label>
            <input id="fCenter" type="number" step="1" min="0" max="10000000000000" value="5000000000000">
            <select id="unit"><option>Hz</option><option>kHz</option><option selected>MHz</option><option>GHz</option><option>THz</option></select>
          </div>

          <div class="row">
            <label>Span:</label>
            <input id="span" type="range" min="1000" max="10000000000000" step="1000000" value="10000000000000" style="width:150px">
            <div class="small" id="spanLbl"></div>
          </div>

          <div class="row"><button id="zoomIn">Zoom +</button><button id="zoomOut">Zoom -</button><button id="zoomFull">Full</button></div>
          <div class="row"><button id="panL">&lt; Pan</button><button id="panR">Pan &gt;</button></div>

          <div class="row">
            <label>Filter:</label>
            <input id="bw" type="range" min="300" max="500000" step="100" value="2400" style="width:150px">
            <div class="small" id="bwLbl">2.40 kHz (USB)</div>
          </div>

          <div class="row">
            <label>Mode:</label>
            <select id="mode"><option>CW</option><option selected>USB</option><option>LSB</option><option>AM</option><option>FM</option><option>IQ</option></select>
            <button id="freeze">Freeze</button><button id="reset">Reset</button>
          </div>

          <div class="small" id="rxInfo"></div>
          <div class="small" id="status">Ready</div>
        </aside>
      </div>
    </div>
  </div>

  <footer><div class="small" id="footerText"></div></footer>

<script>
(function(){'use strict';
/* ---- Konst ---- */
const THZ_MAX=10e12,C_KMS=299792.458,FRAME_BUDGET=16,MAX_CANVAS_SIZE=2048;
const TYPE_COLOR={zivil:'#ffd666',feindlich:'#ff5a5a',verbündet:'#63e28e','störung':'#c0a060',astronomisch:'#66ccff'};
/* ---- Utils ---- */
const clamp=(v,a,b)=>v<a?a:v>b?b:v, rnd=(a,b)=>a+Math.random()*(b-a);
const fmtHz=(f)=>{const a=Math.abs(f);return a>=1e12?(f/1e12).toFixed(3)+' THz':a>=1e9?(f/1e9).toFixed(3)+' GHz':a>=1e6?(f/1e6).toFixed(3)+' MHz':a>=1e3?(f/1e3).toFixed(1)+' kHz':f.toFixed(0)+' Hz';};
const UNIT={Hz:1,kHz:1e3,MHz:1e6,GHz:1e9,THz:1e12}, byUnit=(v,u)=>(UNIT[u]||1)*v;
const doppler=(f0,v)=>f0*(1+v/C_KMS);
const hex2rgba=(hex,a)=>{const h=hex.replace('#','');const r=parseInt(h.slice(0,2),16),g=parseInt(h.slice(2,4),16),b=parseInt(h.slice(4,6),16);return `rgba(${r},${g},${b},${a})`;};

/* ---- Mode Profile ---- */
const MODEP={CW:{scale:.4,min:200,max:1200,visual:'sym',audio:'cw',bfo:650},
  USB:{scale:1,min:1200,max:3200,visual:'upper',audio:'ssb'},
  LSB:{scale:1,min:1200,max:3200,visual:'lower',audio:'ssb'},
  AM:{scale:2,min:3000,max:10000,visual:'sym',audio:'am'},
  FM:{scale:6,min:8000,max:180000,visual:'sym',audio:'fm'},
  IQ:{scale:1,min:1000,max:50000,visual:'sym',audio:'iq'}};

/* ---- DOM ---- */
const spec=document.getElementById('spectrum'), wf=document.getElementById('waterfall');
const sctx=spec.getContext('2d',{alpha:false}), wctx=wf.getContext('2d',{alpha:false});
const fCenter=document.getElementById('fCenter'), unitSel=document.getElementById('unit');
const span=document.getElementById('span'), spanLbl=document.getElementById('spanLbl');
const bwEl=document.getElementById('bw'), bwLbl=document.getElementById('bwLbl'), modeSel=document.getElementById('mode');
const rxInfo=document.getElementById('rxInfo'), statusEl=document.getElementById('status');
const audioStartBtn=document.getElementById('audioStart'), audioToggleBtn=document.getElementById('audioToggle');
const csvUrlEl=document.getElementById('csvUrl'), csvLoadBtn=document.getElementById('csvLoad');

/* ---- State ---- */
let state={isFrozen:false,spanVirtual:THZ_MAX,listenHz:null,audioCtx:null,audioNodes:{},lastFrameTime:0,frameSkip:0};
const sched={rows:[],url:'',lastLoaded:0}; let activeTx=[];

/* ---- Signals (Hintergrund) ---- */
function generateSignals(){
  const s={astroLines:[],spurs:[],pulsars:[]};
  const base=[['H I',1.420405751e9],['OH 1612',1.612231e9],['OH 1665',1.6654018e9],['CO(1-0)',115.2712018e9],['[C II]',1.900539e12]];
  for(const [name,f0] of base){const v=rnd(-200,200),f=doppler(f0,v),bw=Math.max(500,f*(rnd(5,50)/C_KMS)); s.astroLines.push({name,f,bw,amp:rnd(.4,.7)});}
  for(let i=0;i<8;i++) s.spurs.push({f:Math.random()*THZ_MAX,bw:rnd(200,8000),amp:rnd(.15,.35)});
  const t0=performance.now()/1000; for(let i=0;i<2;i++){const fmin=rnd(50e6,800e6); s.pulsars.push({fmin,fmax:fmin+rnd(50e6,300e6),period:rnd(.3,1.2),duty:rnd(.05,.08),amp:rnd(.4,.6),t0:t0+rnd(0,3)});}
  return s;
}
const signals=generateSignals();

/* ---- Plan: CSV laden/parsen ---- */
csvLoadBtn.onclick=async ()=>{
  if(!csvUrlEl.value){ setStatus('CSV URL fehlt'); return; }
  try{
    const res=await fetch(csvUrlEl.value,{cache:'no-store',mode:'cors'}); const txt=await res.text();
    sched.rows=parseScheduleCSV(txt); sched.url=csvUrlEl.value; sched.lastLoaded=Date.now();
    setStatus('Plan geladen: '+sched.rows.length);
  }catch(e){ setStatus('CSV Fehler: '+e.message); }
};
function parseScheduleCSV(txt){
  const lines=txt.split(/\r?\n/).filter(l=>l.trim()); if(!lines.length) return [];
  const H=splitCSVLine(lines[0]).map(s=>s.trim().toLowerCase()), idx=k=>H.indexOf(k), out=[];
  for(let i=1;i<lines.length;i++){
    const c=splitCSVLine(lines[i]); if(!c.length) continue;
    const get=k=>{const j=idx(k); return j>=0?(c[j]||'').trim():''};
    const tStr=get('zeit'), fStr=get('frequenz')||get('freq'), art=(get('art')||'zivil').toLowerCase();
    let mode=(get('modus')||'').toUpperCase(); const dStr=get('dauer'); const content=parseContentSpec(get('inhalt')||get('content')||'');
    const timeSec=parseHHMMopt(tStr), durSec=parseHMSopt(dStr), always=(timeSec==null||durSec==null);
    const freq=parseFreq(fStr); if(!isFinite(freq)||freq<=0) continue;
    if(!mode) mode=(content.modeHint||'AM');
    const name=content.text?content.text.slice(0,24):(content.url||'').split('/').pop()||'TX';
    out.push({always,timeSec,durSec,type:art,mode,freq,content,name});
  } return out;
}
function splitCSVLine(line){const out=[];let cur='',q=false;for(let i=0;i<line.length;i++){const ch=line[i];
  if(ch==='\"'){if(q&&line[i+1]==='\"'){cur+='\"';i++;}else q=!q;} else if(ch===','&&!q){out.push(cur);cur='';} else cur+=ch;}
  out.push(cur);return out;}
function parseHHMMopt(s){if(!s) return null; const m=String(s).match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/); if(!m) return null;
  const h=+m[1],mi=+m[2],se=+(m[3]||0); if(h>23||mi>59||se>59) return null; return h*3600+mi*60+se;}
function parseHMSopt(s){if(!s) return null; const m=String(s).match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/); if(!m) return null;
  const h=+m[1],mi=+m[2],se=+(m[3]||0); return h*3600+mi*60+se;}
function parseFreq(s){if(!s) return NaN; const m=String(s).trim().match(/^([\d.]+)\s*([kKmMgGtT]?[hH][zZ])?$/);
  if(!m) return parseFloat(s)||NaN; const v=parseFloat(m[1]); const u=(m[2]||'Hz').toLowerCase();
  const mul=u.startsWith('thz')?1e12:u.startsWith('ghz')?1e9:u.startsWith('mhz')?1e6:u.startsWith('khz')?1e3:1; return v*mul;}
function parseContentSpec(s){
  const out={kind:'cw',url:'',text:'',modeHint:'',af:null,dev:null,wpm:18,tone:700,sstvMode:'MARTIN_M1'};
  if(!s) return out; const head=s.split(':',1)[0].toUpperCase();
  if(head==='SSTV'){const rest=s.slice(5);const [val,...ops]=rest.split(';');const kv=Object.fromEntries(ops.map(p=>{const[t,v]=p.split('=');return[(t||'').toLowerCase(),(v||'')]}));
    out.kind='sstv';out.url=val.trim();out.modeHint='USB';out.af=2900;out.sstvMode=(kv.mode||'MARTIN_M1').toUpperCase();}
  else if(head==='AUDIO'){const rest=s.slice(6);const [val,...ops]=rest.split(';');const kv=Object.fromEntries(ops.map(p=>{const[t,v]=p.split('=');return[(t||'').toLowerCase(),(v||'')]}));
    out.kind='audio';out.url=val.trim();out.modeHint=(kv.mode||'').toUpperCase();out.af=kv.af?+kv.af:null;out.dev=kv.dev?+kv.dev:null;}
  else if(head==='CW'){const rest=s.slice(3);const [val,...ops]=rest.split(';');const kv=Object.fromEntries(ops.map(p=>{const[t,v]=p.split('=');return[(t||'').toLowerCase(),(v||'')]}));
    out.kind='cw';out.text=val.trim();out.wpm=kv.wpm?+kv.wpm:18;out.tone=kv.tone?+kv.tone:700;}
  else{out.kind='cw';out.text=s.trim();}
  return out;
}
function inferRFbw(tx){
  const m=tx.mode.toUpperCase();
  if(m==='CW'){const wpm=tx.content?.wpm||18;const dit=1.2/wpm;const tau=Math.max(0.004,0.15*dit);return clamp(1.4/tau,150,900);}
  if(m==='USB'||m==='LSB'){const af=tx.content?.af||2700;return clamp(af,1200,3200);}
  if(m==='AM'){const af=tx.content?.af||5000;return clamp(2*af,3000,12000);}
  if(m==='FM'){const dev=tx.content?.dev||2500,af=tx.content?.af||3000;return clamp(2*(dev+af),8000,200000);}
  if(m==='SSTV') return 2900;
  return 3000;
}

/* ---- Plan: Aktivierung ---- */
function updateActiveSchedule(nowMs){
  if(!sched.rows.length) { activeTx.length=0; return; }
  const d=new Date(nowMs); const sec=d.getHours()*3600+d.getMinutes()*60+d.getSeconds();
  const want=[];
  for(const r of sched.rows){
    let on=r.always;
    if(!on){
      const start=r.timeSec, dur=r.durSec, end=(start+dur)%86400;
      on = dur>=86400 ? true : (end>start ? (sec>=start && sec<end) : (sec>=start || sec<end));
    }
    if(!on) continue;
    const key=[r.freq,r.mode,r.timeSec??-1,r.durSec??-1,r.name].join('|'); want.push(key);
    if(!activeTx.find(t=>t.key===key)){
      const bw=inferRFbw(r);
      activeTx.push({key,name:r.name,type:r.type,mode:r.mode,f:r.freq,bw,amp:.65,drift:0,tStart:nowMs,content:r.content});
    }
  }
  for(let i=activeTx.length-1;i>=0;i--) if(!want.includes(activeTx[i].key)) activeTx.splice(i,1);
}

/* ---- Freq helpers ---- */
function setCenterHz(f){const u=unitSel.value; fCenter.value=(f/byUnit(1,u)).toFixed(3);}
function getCenterHz(){return byUnit(parseFloat(fCenter.value)||0,unitSel.value);}
function getSpan(){return state.spanVirtual;}
function setSpan(v){state.spanVirtual=clamp(v,1e3,THZ_MAX); span.value=Math.min(state.spanVirtual,1e13); spanLbl.textContent=fmtHz(state.spanVirtual);}
function xToHz(x){const fc=getCenterHz(),sp=getSpan(); return fc+(x-.5)*sp;}
function hzToX(hz){const fc=getCenterHz(),sp=getSpan(); return ((hz-fc)/sp)+.5;}
function clampView(fc,sp){let fMin=fc-sp/2,fMax=fc+sp/2; if(fMin<0) fc+=-fMin; if(fMax>THZ_MAX) fc-=(fMax-THZ_MAX); return fc;}

/* ---- Canvas ---- */
function resizeCanvas(canvas,container){const r=container.getBoundingClientRect();const dpr=1;const w=Math.min(MAX_CANVAS_SIZE,Math.max(32,r.width*dpr));const h=Math.min(MAX_CANVAS_SIZE,Math.max(32,r.height*dpr));
  if(canvas.width!==w||canvas.height!==h){canvas.width=w;canvas.height=h;canvas.style.width=r.width+'px';canvas.style.height=r.height+'px';return true;} return false;}
function layout(){resizeCanvas(spec,document.querySelector('.spectrum-container')); resizeCanvas(wf,document.querySelector('.waterfall-container'));}

/* ---- Audio ---- */
function initAudio(){ if(state.audioCtx) return true; try{
  const Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) return false;
  state.audioCtx=new Ctx(); state.audioNodes.gate=state.audioCtx.createGain(); state.audioNodes.gate.gain.value=0;
  state.audioNodes.osc=state.audioCtx.createOscillator(); state.audioNodes.osc.type='sine'; state.audioNodes.osc.frequency.value=600;
  state.audioNodes.oscGain=state.audioCtx.createGain(); state.audioNodes.oscGain.gain.value=.1;
  const N=state.audioCtx.sampleRate*4, buf=state.audioCtx.createBuffer(1,N,state.audioCtx.sampleRate), d=buf.getChannelData(0);
  for(let i=0;i<N;i++) d[i]=(Math.random()*2-1)*.3;
  state.audioNodes.noise=state.audioCtx.createBufferSource(); state.audioNodes.noise.buffer=buf; state.audioNodes.noise.loop=true;
  state.audioNodes.noiseFilter=state.audioCtx.createBiquadFilter(); state.audioNodes.noiseGain=state.audioCtx.createGain(); state.audioNodes.noiseGain.gain.value=.1;
  state.audioNodes.osc.connect(state.audioNodes.oscGain).connect(state.audioNodes.gate);
  state.audioNodes.noise.connect(state.audioNodes.noiseFilter).connect(state.audioNodes.noiseGain).connect(state.audioNodes.gate);
  state.audioNodes.gate.connect(state.audioCtx.destination); state.audioNodes.osc.start(); return true;}catch(e){return false;}}
function applyAudioProfile(){ if(!state.audioCtx||!state.audioNodes.noiseFilter) return;
  const m=MODEP[modeSel.value], ctx=state.audioCtx, f=state.audioNodes.noiseFilter, og=state.audioNodes.oscGain, ng=state.audioNodes.noiseGain;
  if(m.audio==='cw'){f.type='bandpass';f.frequency.value=m.bfo;f.Q.value=8; og.gain.setTargetAtTime(.08,ctx.currentTime,.1); ng.gain.setTargetAtTime(.05,ctx.currentTime,.1);}
  else if(m.audio==='ssb'){f.type='bandpass';f.frequency.value=1500;f.Q.value=.9; og.gain.setTargetAtTime(.06,ctx.currentTime,.1); ng.gain.setTargetAtTime(.06,ctx.currentTime,.1);}
  else if(m.audio==='am'){f.type='lowpass';f.frequency.value=4000;f.Q.value=.707; og.gain.setTargetAtTime(.04,ctx.currentTime,.1); ng.gain.setTargetAtTime(.08,ctx.currentTime,.1);}
  else if(m.audio==='fm'){f.type='lowpass';f.frequency.value=5000;f.Q.value=.707; og.gain.setTargetAtTime(.05,ctx.currentTime,.1); ng.gain.setTargetAtTime(.07,ctx.currentTime,.1);}
  else {f.type='bandpass';f.frequency.value=1500;f.Q.value=.7; og.gain.setTargetAtTime(.05,ctx.currentTime,.1); ng.gain.setTargetAtTime(.06,ctx.currentTime,.1);}}

/* ---- Rendering ---- */
const renderData={spectrumData:null,waterfallLine:null,lastWidth:0};
function ensureBuffers(w){ if(renderData.lastWidth!==w){renderData.spectrumData=new Float32Array(w); renderData.waterfallLine=new ImageData(w,1); renderData.lastWidth=w;} }

const signalCache={lastHz:-1,lastT:-1,cachedValue:0};
function getSignalPower(hz,t,pxHz){
  const key=(hz/1000|0)*1000; if(signalCache.lastHz===key&&Math.abs(signalCache.lastT-t)<.1) return signalCache.cachedValue+(Math.random()-.5)*.02;
  let power=0.03+(Math.random()-.5)*.015;
  for(const s of signals.astroLines){const half=Math.max(s.bw*.5,pxHz*.5),d=Math.abs(hz-s.f); if(d<half) power+=s.amp*(1-d/half);}
  for(const s of signals.spurs){const half=Math.max(s.bw*.5,pxHz),d=Math.abs(hz-s.f); if(d<half) power+=s.amp*(1-d/half);}
  for(const p of signals.pulsars){ if(hz>=p.fmin&&hz<=p.fmax){const ph=((t-p.t0)%p.period+p.period)%p.period; if(ph<p.period*p.duty) power+=p.amp*.8;}}
  for(const tx of activeTx){
    const fc=tx.f, half=Math.max(tx.bw*.5,pxHz);
    if(tx.mode==='AM'){
      const d=Math.abs(hz-fc); if(d<half) power += tx.amp*(1-d/half);
      const carr=Math.abs(hz-fc), cHalf=Math.max(pxHz*.5,50); if(carr<cHalf) power += 0.2*tx.amp*(1-carr/cHalf);
      continue;
    }
    if(tx.mode==='USB'||tx.mode==='SSTV'){const lo=fc, hi=fc+tx.bw; if(hz>=lo&&hz<=hi){const w=Math.max(tx.bw,pxHz*2); power+=tx.amp*clamp(1-(hz-lo)/w,.2,1);} continue;}
    if(tx.mode==='LSB'){const lo=fc-tx.bw, hi=fc; if(hz>=lo&&hz<=hi){const w=Math.max(tx.bw,pxHz*2); power+=tx.amp*clamp(1-(hi-hz)/w,.2,1);} continue;}
    if(tx.mode==='FM'){const d=Math.abs(hz-fc); if(d<half){const x=d/half, ripple=.12*Math.cos(8*Math.PI*x); power+=tx.amp*(0.65+0.35*(1-x)+ripple);} continue;}
    if(tx.mode==='CW'){const cwHalf=Math.max(half*.25,80), d=Math.abs(hz-fc); if(d<cwHalf){const x=d/cwHalf; power+=tx.amp*Math.exp(-3*x*x);} continue;}
    const d=Math.abs(hz-fc); if(d<half) power+=tx.amp*(1-d/half);
  }
  signalCache.lastHz=key; signalCache.lastT=t; signalCache.cachedValue=power; return Math.max(0,power);
}

function drawSpectrum(){
  const W=spec.width,H=spec.height; if(W<1||H<1) return; ensureBuffers(W);
  const t=performance.now()/1000, pxHz=getSpan()/W, data=renderData.spectrumData; let vmax=.1;
  for(let x=0;x<W;x++){const hz=xToHz(x/W), v=getSignalPower(hz,t,pxHz); data[x]=v; if(v>vmax) vmax=v;}
  sctx.fillStyle='#0f1218'; sctx.fillRect(0,0,W,H);
  sctx.strokeStyle='#87a3ff'; sctx.beginPath(); const g=1/vmax;
  for(let x=0;x<W;x++){const y=H-(clamp(data[x]*g,0,1)*H); if(x===0) sctx.moveTo(x,y); else sctx.lineTo(x,y);} sctx.stroke();
  sctx.fillStyle='#b8c1e1'; sctx.font='10px monospace'; const n=5; for(let i=0;i<=n;i++){const f=xToHz(i/n); sctx.fillText(fmtHz(f), i*W/n+2, 12);}
  drawOverlays(sctx,W,H,pxHz);
}
function ensureLine(w){ if(renderData.lastWidth!==w) ensureBuffers(w); return renderData.waterfallLine; }
function drawWaterfall(){
  if(state.isFrozen) return; const W=wf.width,H=wf.
  height; if(W<1||H<1) return; ensureBuffers(W);
  if(H>1) wctx.drawImage(wf,0,0,W,H-1,0,1,W,H-1);
  const t=performance.now()/1000, pxHz=getSpan()/W, line=ensureLine(W), px=line.data; let vmax=.1;
  for(let x=0;x<W;x++){const hz=xToHz(x/W), v=getSignalPower(hz,t,pxHz); if(v>vmax) vmax=v;
    const q=clamp(v/vmax,0,1), r=(40+200*Math.pow(q,1.2))|0, g=(20+180*q)|0, b=(80+175*q)|0, i=x<<2; px[i]=r;px[i+1]=g;px[i+2]=b;px[i+3]=255;}
  wctx.putImageData(line,0,0); drawOverlays(wctx,W,H,pxHz);
}
function drawOverlays(ctx,W,H,pxHz){
  const fc=getCenterHz(), sp=getSpan(), fmin=fc-sp/2;
  ctx.save();
  ctx.fillStyle='#ffc94d'; for(const s of signals.astroLines){ if(s.f>=fmin&&s.f<=fmin+sp){const x=((s.f-fmin)/sp)*W; ctx.fillRect(x,0,Math.max(1,pxHz/sp*W*2),4);}}
  for(const tx of activeTx){
    const col=TYPE_COLOR[tx.type]||'#8aa';
    let xL,xR; if(tx.mode==='USB'||tx.mode==='SSTV'){xL=((tx.f-fmin)/sp)*W; xR=((tx.f+tx.bw-fmin)/sp)*W;}
    else if(tx.mode==='LSB'){xL=((tx.f-tx.bw-fmin)/sp)*W; xR=((tx.f-fmin)/sp)*W;}
    else {xL=((tx.f-tx.bw/2-fmin)/sp)*W; xR=((tx.f+tx.bw/2-fmin)/sp)*W;}
    const w=Math.max(2,xR-xL);
    ctx.fillStyle=hex2rgba(col,.14); ctx.fillRect(Math.max(0,xL),0,w,H);
    ctx.strokeStyle=hex2rgba(col,.55); ctx.beginPath(); ctx.moveTo(xL,0); ctx.lineTo(xL,H); ctx.moveTo(xR,0); ctx.lineTo(xR,H); ctx.stroke();
    ctx.fillStyle='rgba(255,255,255,.85)'; ctx.font='bold 10px monospace';
    ctx.fillText(`${tx.name} [${tx.mode}]`, Math.max(2,xL+2), 12);
  }
  if(state.listenHz!==null){ const pb=getCurrentPassband(); if(pb){
    const xL=((pb.lo-fmin)/sp)*W, xH=((pb.hi-fmin)/sp)*W, xC=((pb.center-fmin)/sp)*W, mode=modeSel.value;
    const colors={sym:'rgba(0,200,255,.15)',upper:'rgba(0,255,160,.15)',lower:'rgba(255,120,0,.15)'}; const visual=MODEP[mode].visual;
    ctx.fillStyle=colors[visual]||colors.sym; ctx.fillRect(Math.max(0,xL),0,Math.max(1,xH-xL),H);
    ctx.strokeStyle=ctx.fillStyle.replace('0.15','0.6'); ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(xL,0);ctx.lineTo(xL,H);ctx.moveTo(xH,0);ctx.lineTo(xH,H);ctx.stroke();
    ctx.strokeStyle='rgba(255,255,255,.8)'; ctx.setLineDash([4,4]); ctx.beginPath(); ctx.moveTo(xC,0); ctx.lineTo(xC,H); ctx.stroke(); ctx.setLineDash([]);
  }}
  ctx.restore();
}
function getCurrentPassband(){ if(state.listenHz===null) return null; const bw=getEffectiveBandwidth(), m=modeSel.value;
  if(m==='USB') return {lo:state.listenHz, hi:state.listenHz+bw, center:state.listenHz};
  if(m==='LSB') return {lo:state.listenHz-bw, hi:state.listenHz, center:state.listenHz};
  return {lo:state.listenHz-bw/2, hi:state.listenHz+bw/2, center:state.listenHz};}
function getEffectiveBandwidth(){const m=MODEP[modeSel.value]; const base=parseFloat(bwEl.value)||2400; return clamp(base*m.scale,m.min,m.max);}

/* ---- Loop ---- */
let lastSched=0;
function mainLoop(){
  const now=performance.now(); if(now-state.lastFrameTime<FRAME_BUDGET){state.frameSkip++; if(state.frameSkip<2){requestAnimationFrame(mainLoop);return;}}
  state.frameSkip=0; state.lastFrameTime=now;
  if(now-lastSched>1000){ updateActiveSchedule(Date.now()); lastSched=now; }
  try{drawSpectrum(); drawWaterfall(); updateInfo();}catch(e){}
  requestAnimationFrame(mainLoop);
}
function updateInfo(){const fc=getCenterHz(), sp=getSpan(), fMin=fc-sp/2, fMax=fc+sp/2; rxInfo.textContent=`View: ${fmtHz(fMin)} … ${fmtHz(fMax)} | Center: ${fmtHz(fc)} | TX: ${activeTx.length}`;}

/* ---- Controls ---- */
function setupControls(){
  document.getElementById('zoomIn').onclick=()=>applyZoom(1.5);
  document.getElementById('zoomOut').onclick=()=>applyZoom(1/1.5);
  document.getElementById('zoomFull').onclick=()=>setFullBand();
  document.getElementById('panL').onclick=()=>panBy(-.2);
  document.getElementById('panR').onclick=()=>panBy(.2);
  document.getElementById('freeze').onclick=()=>{state.isFrozen=!state.isFrozen; document.getElementById('freeze').textContent=state.isFrozen?'Unfreeze':'Freeze';};
  document.getElementById('reset').onclick=()=>{setFullBand(); state.listenHz=null; setStatus('Reset');};
  span.oninput=()=>setSpan(parseFloat(span.value));
  unitSel.onchange=()=>setCenterHz(getCenterHz());
  bwEl.oninput=updateBwLabel; modeSel.onchange=()=>{updateBwLabel(); applyAudioProfile();};

  audioStartBtn.onclick=async()=>{try{
    if(state.audioCtx&&state.audioCtx.state==='suspended') await state.audioCtx.resume();
    if(initAudio()&&state.audioNodes.noise){ await state.audioNodes.noise.start(); applyAudioProfile();
      audioStartBtn.style.display='none'; audioToggleBtn.style.display=''; audioToggleBtn.textContent='Audio Pause';
      state.audioNodes.gate.gain.setTargetAtTime(.3,state.audioCtx.currentTime,.1); setStatus('Audio bereit');}
    else throw new Error('Audio init fehlgeschlagen');}catch(e){setStatus('Audio Fehler: '+e.message);}};

  audioToggleBtn.onclick=()=>{ if(!state.audioCtx||!state.audioNodes.gate) return;
    const g=state.audioNodes.gate.gain.value>0.1?0:.3; state.audioNodes.gate.gain.setTargetAtTime(g,state.audioCtx.currentTime,.1);
    audioToggleBtn.textContent=g>0?'Audio Pause':'Audio Resume'; if(g>0) updateAudio(); };
}
function applyZoom(f,anchorHz=null){const sp=getSpan(), nsp=clamp(sp/f,1e3,THZ_MAX), x=anchorHz?hzToX(anchorHz):.5; setSpan(nsp); const fc=clampView(anchorHz?(anchorHz-(x-.5)*nsp):getCenterHz(),nsp); setCenterHz(fc);}
function panBy(frac){const shift=frac*getSpan(); setCenterHz(clampView(getCenterHz()+shift,getSpan()));}
function setFullBand(){setSpan(THZ_MAX); setCenterHz(THZ_MAX/2);}
function updateBwLabel(){const eff=getEffectiveBandwidth(), m=modeSel.value, lbl=eff>=1e6?(eff/1e6).toFixed(2)+' MHz':(eff/1e3).toFixed(2)+' kHz'; bwLbl.textContent=lbl+' ('+m+')';}
function setStatus(msg){statusEl.textContent=msg; setTimeout(()=>statusEl.textContent='Ready',2000);}

/* ---- Interaction ---- */
function setupInteraction(){
  let isDown=false,startX=0,startFc=0,moved=0;
  const getX=e=>e.clientX||(e.touches&&e.touches[0]&&e.touches[0].clientX)||0;
  function start(e){e.preventDefault(); isDown=true; startX=getX(e); startFc=getCenterHz(); moved=0;}
  function move(e){if(!isDown) return; const r=wf.getBoundingClientRect(), dx=getX(e)-startX; moved=Math.max(moved,Math.abs(dx));
    const shift=-dx/r.width*getSpan(); setCenterHz(clampView(startFc+shift,getSpan()));}
  function end(e){if(!isDown) return; isDown=false; if(moved<5){const r=wf.getBoundingClientRect(); const x=clamp((getX(e)-r.left)/r.width,0,1); state.listenHz=xToHz(x); setStatus(`Tuned ${fmtHz(state.listenHz)} | ${modeSel.value}`); updateAudio();}}
  function wheel(e){e.preventDefault(); const r=wf.getBoundingClientRect(); const x=clamp((e.clientX-r.left)/r.width,0,1); applyZoom(Math.pow(1.3,-Math.sign(e.deltaY)), xToHz(x));}
  function dbl(e){const r=wf.getBoundingClientRect(); const x=clamp((e.clientX-r.left)/r.width,0,1); const hz=xToHz(x); setCenterHz(clampView(hz,getSpan())); setStatus('Center '+fmtHz(hz));}
  wf.addEventListener('mousedown',start,{passive:false}); wf.addEventListener('mousemove',move,{passive:true}); wf.addEventListener('mouseup',end,{passive:true});
  wf.addEventListener('wheel',wheel,{passive:false}); wf.addEventListener('dblclick',dbl,{passive:true});
  wf.addEventListener('touchstart',start,{passive:false}); wf.addEventListener('touchmove',move,{passive:true}); wf.addEventListener('touchend',end,{passive:true});
  wf.addEventListener('contextmenu',e=>e.preventDefault(),{passive:false});
}
function updateAudio(){ if(!state.audioCtx||!state.audioNodes.gate||state.listenHz===null) return;
  if(state.audioCtx.state==='suspended') state.audioCtx.resume();
  const pb=getCurrentPassband(); if(!pb) return; const t=performance.now()/1000, pxHz=getSpan()/Math.max(wf.width,1);
  let tot=0,peak=0,wfHz=0, N=16; for(let i=0;i<N;i++){const f=pb.lo+(i/(N-1))*(pb.hi-pb.lo), p=getSignalPower(f,t,pxHz); tot+=p; wfHz+=p*f; if(p>peak) peak=p;}
  const avg=tot/N, cm=tot>0?wfHz/tot:pb.center, m=MODEP[modeSel.value]; let af=800, nLvl=.08;
  if(m.audio==='cw'){const off=Math.abs(cm-state.listenHz), mOff=(pb.hi-pb.lo)/2; af=m.bfo+(off/mOff)*400; nLvl=.04+peak*.3;}
  else if(m.audio==='ssb'){af=modeSel.value==='USB'?clamp((cm-pb.lo)*.8,200,3000):clamp((pb.hi-cm)*.8,200,3000); nLvl=.06+avg*.4;}
  else if(m.audio==='am'){af=clamp(600+(peak-avg)*500,300,1500); nLvl=.04+avg*.6;}
  else if(m.audio==='fm'){const dev=(cm-state.listenHz)/(pb.hi-pb.lo)*2000; af=clamp(1000+dev+(Math.random()-.5)*avg*200,300,3000); nLvl=.03+avg*.4;}
  else {af=clamp(800+(avg-.5)*600,400,2000); nLvl=.05+avg*.35;}
  state.audioNodes.gate.gain.setTargetAtTime(clamp(Math.sqrt(avg)*1.5,.05,.8),state.audioCtx.currentTime,.15);
  state.audioNodes.osc.frequency.setTargetAtTime(clamp(af,100,4000),state.audioCtx.currentTime,.08);
  state.audioNodes.noiseGain.gain.setTargetAtTime(clamp(nLvl,.01,.3),state.audioCtx.currentTime,.12);
  state.audioNodes.oscGain.gain.setTargetAtTime(clamp(peak*.15,.02,.2),state.audioCtx.currentTime,.1);
}

/* ---- Init ---- */
function init(){
  setFullBand(); updateBwLabel(); setupControls(); setupInteraction(); layout();
  setStatus('SDR Ready'); requestAnimationFrame(mainLoop);
  
  function pad(n){return n<10?'0'+n:n;}
  const now=new Date();
  const ts=now.getFullYear()+"-"+pad(now.getMonth()+1)+"-"+pad(now.getDate())+" "+pad(now.getHours())+":"+pad(now.getMinutes())+":"+pad(now.getSeconds());
  document.getElementById("footerText").textContent="© Anaxes Naval System – Dev Timestamp: "+ts;
}

window.addEventListener('error',e=>{setStatus('Error: '+(e.message||'unknown'));},{passive:true});
window.addEventListener('unhandledrejection',e=>{e.preventDefault();},{passive:true});
if(window.gmod){window.gmodSDR={setFrequency:(hz)=>{setCenterHz(hz);setStatus('GMod set '+fmtHz(hz));},getFrequency:()=>getCenterHz(),
 setSpan:(hz)=>{setSpan(hz);setStatus('Span '+fmtHz(hz));},getSpan:()=>getSpan(), tune:(hz)=>{state.listenHz=hz;updateAudio();}, freeze:(f)=>{state.isFrozen=!!f;}};}
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded',init,{passive:true}); else setTimeout(init,10);
})();
</script>
</body>
</html>